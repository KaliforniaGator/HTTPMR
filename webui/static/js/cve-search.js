// CVE Search JavaScript - AJAX with lazy loading
document.addEventListener('DOMContentLoaded', function() {
    const searchForm = document.getElementById('searchForm');
    const searchBtn = document.getElementById('searchBtn');
    const searchProgress = document.getElementById('searchProgress');
    const progressBar = document.getElementById('progressBar');
    const progressInfo = document.querySelector('.progress-info span');
    const queryInput = document.getElementById('query');
    const resultsContainer = document.getElementById('searchResultsContainer');
    
    let searchInProgress = false;
    let loadingMore = false;
    let currentQuery = '';
    let currentOffset = 0;
    let totalResults = 0;
    let hasMoreResults = false;
    let allResults = []; // Store all results for client-side sorting
    let currentSort = 'newest';
    
    if (searchForm) {
        searchForm.addEventListener('submit', function(e) {
            e.preventDefault();
            const query = queryInput.value.trim();
            
            if (searchInProgress || !query) {
                return;
            }
            
            performSearch(query);
        });
    }
    
    async function performSearch(query, resetResults = true) {
        if (resetResults) {
            currentQuery = query;
            currentOffset = 0;
            totalResults = 0;
            hasMoreResults = false;
            allResults = []; // Clear all results for new search
        }
        
        if (resetResults) {
            searchInProgress = true;
            searchBtn.disabled = true;
            searchBtn.classList.add('search-disabled');
            searchProgress.style.display = 'block';
            progressBar.value = 0;
            progressInfo.textContent = 'Searching CVE database...';
        } else {
            loadingMore = true;
        }
        
        try {
            // Get search progress info
            const progressResponse = await fetch(`/api/cves/search_progress?query=${encodeURIComponent(query)}`);
            const progressData = await progressResponse.json();
            
            if (progressData.error) {
                throw new Error(progressData.error);
            }
            
            // Update progress text
            if (progressData.optimization_applied) {
                progressInfo.textContent = `Optimized search: ${progressData.cv_es_to_search.toLocaleString()} CVEs from ${progressData.platform} (${progressData.min_year}+)`;
            } else {
                progressInfo.textContent = `Full search: ${progressData.cv_es_to_search.toLocaleString()} CVEs (all years)`;
            }
            
            // Animate progress bar
            animateProgress(progressData.optimization_applied ? 2000 : 5000);
            
            // Perform actual search
            const searchResponse = await fetch(`/api/cves/search?query=${encodeURIComponent(query)}&offset=${currentOffset}&limit=30`);
            const searchData = await searchResponse.json();
            
            if (searchData.error) {
                throw new Error(searchData.error);
            }
            
            // Update state
            totalResults = searchData.count;
            hasMoreResults = searchData.has_more;
            
            // Add new results to allResults array
            if (resetResults) {
                allResults = searchData.results;
            } else {
                allResults.push(...searchData.results);
            }
            
            // Sort and render results
            sortAndRenderResults();
            
        } catch (error) {
            console.error('Search error:', error);
            showError('Search failed. Please try again.');
        } finally {
            if (resetResults) {
                hideProgress();
            } else {
                hideLoadingMore();
            }
        }
    }
    
    function sortAndRenderResults() {
        // Sort all results based on current sort order
        if (currentSort === 'oldest') {
            allResults.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
        } else {
            allResults.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
        }
        
        // Render paginated results
        const paginatedResults = allResults.slice(0, currentOffset + 30);
        
        if (currentOffset === 0) {
            renderSearchResults({
                query: currentQuery,
                results: paginatedResults,
                count: totalResults,
                has_more: hasMoreResults
            });
        } else {
            appendSearchResults({
                results: paginatedResults.slice(currentOffset, currentOffset + 30),
                has_more: hasMoreResults
            });
        }
    }
    
    function animateProgress(duration) {
        const maxProgress = 85;
        const steps = 30;
        const increment = maxProgress / steps;
        const stepDuration = duration / steps;
        
        let progress = 0;
        const interval = setInterval(() => {
            progress += increment;
            if (progress >= maxProgress) {
                progress = maxProgress;
                clearInterval(interval);
                progressInfo.textContent = 'Loading results...';
            }
            progressBar.value = progress;
        }, Math.max(50, stepDuration));
    }
    
    function hideProgress() {
        searchProgress.style.display = 'none';
        searchBtn.disabled = false;
        searchBtn.classList.remove('search-disabled');
        searchInProgress = false;
    }
    
    function hideLoadingMore() {
        loadingMore = false;
        const loadMoreBtn = document.querySelector('.load-more-btn');
        if (loadMoreBtn) {
            loadMoreBtn.disabled = false;
            loadMoreBtn.innerHTML = 'Load More Results';
        }
    }
    
    function showError(message) {
        resultsContainer.innerHTML = `
            <div class="error-state" style="margin-top: var(--space-lg); text-align: center;">
                <i class="fas fa-exclamation-triangle" style="color: var(--color-error); font-size: 2rem;"></i>
                <p style="color: var(--color-error); margin-top: var(--space-sm);">${message}</p>
            </div>
        `;
    }
    
    function renderSearchResults(data) {
        if (data.count === 0) {
            resultsContainer.innerHTML = `
                <div class="empty-state" style="margin-top: var(--space-lg);">
                    <i class="fas fa-circle-question"></i>
                    <p>No CVEs matched "${data.query}"</p>
                </div>
            `;
            return;
        }
        
        const resultsHtml = `
            <div class="search-header">
                <div class="flex justify-between items-center">
                    <h3>${data.count} match${data.count != 1 ? 'es' : ''}</h3>
                    <button class="btn btn-outline btn-sm" type="button" onclick="clearSearch()">Clear</button>
                </div>
            </div>
            <div class="search-results list" style="margin-top: var(--space-md);">
                ${data.results.map(entry => `
                    <a class="list-item" href="/cves/${entry.id}?query=${encodeURIComponent(data.query)}">
                        <div>
                            <div class="list-title">${entry.id}</div>
                            <div class="list-subtitle">${entry.timestamp}</div>
                        </div>
                        <div class="badges">
                            <span class="badge badge-dark">${entry.year}</span>
                        </div>
                    </a>
                `).join('')}
            </div>
            ${data.has_more ? `
                <div class="load-more-container" style="margin-top: var(--space-md); text-align: center;">
                    <button class="btn btn-outline load-more-btn" type="button" onclick="loadMoreResults()">
                        Load More Results (${data.results.length + currentOffset} of ${data.count} shown)
                    </button>
                </div>
            ` : ''}
        `;
        
        resultsContainer.innerHTML = resultsHtml;
    }
    
    function appendSearchResults(data) {
        const resultsList = resultsContainer.querySelector('.search-results');
        const loadMoreContainer = resultsContainer.querySelector('.load-more-container');
        
        // Append new results
        const newResultsHtml = data.results.map(entry => `
            <a class="list-item" href="/cves/${entry.id}?query=${encodeURIComponent(data.query)}">
                <div>
                    <div class="list-title">${entry.id}</div>
                    <div class="list-subtitle">${entry.timestamp}</div>
                </div>
                <div class="badges">
                    <span class="badge badge-dark">${entry.year}</span>
                </div>
            </a>
        `).join('');
        
        resultsList.insertAdjacentHTML('beforeend', newResultsHtml);
        
        // Update or remove load more button
        if (data.has_more) {
            if (loadMoreContainer) {
                loadMoreContainer.querySelector('button').textContent = 
                    `Load More Results (${data.results.length + currentOffset} of ${data.count} shown)`;
            }
        } else if (loadMoreContainer) {
            loadMoreContainer.remove();
        }
    }
    
    window.loadMoreResults = async function() {
        if (!searchInProgress && !loadingMore && hasMoreResults && currentQuery) {
            currentOffset += 30;
            
            // Update button to show loading state
            const loadMoreBtn = document.querySelector('.load-more-btn');
            if (loadMoreBtn) {
                loadMoreBtn.disabled = true;
                loadMoreBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Loading...';
            }
            
            await performSearch(currentQuery, false);
        }
    };
    
    window.clearSearch = function() {
        queryInput.value = '';
        queryInput.focus();
        resultsContainer.innerHTML = '';
        currentQuery = '';
        currentOffset = 0;
        totalResults = 0;
        hasMoreResults = false;
        allResults = [];
        currentSort = 'newest';
    };
    
    // Hide progress on page load if there's a search query (results are loaded)
    if (window.location.search.includes('query=')) {
        const searchProgress = document.getElementById('searchProgress');
        if (searchProgress) {
            searchProgress.style.display = 'none';
        }
    }
    
    // Always load year buckets
    loadYearBuckets();
});

// Load year buckets via AJAX
async function loadYearBuckets() {
    try {
        const response = await fetch('/api/cves/year_buckets');
        const data = await response.json();
        
        if (data.error) {
            throw new Error(data.error);
        }
        
        renderYearBuckets(data.year_buckets);
    } catch (error) {
        console.error('Error loading year buckets:', error);
    }
}

function renderYearBuckets(yearBuckets) {
    const yearGrid = document.querySelector('.year-grid');
    if (!yearGrid) return;
    
    yearGrid.innerHTML = '';
    
    yearBuckets.forEach(bucket => {
        const yearPanel = document.createElement('div');
        yearPanel.className = 'card year-panel';
        
        const entriesHtml = bucket.entries.length > 0 
            ? `<div class="year-list">
                ${bucket.entries.map(entry => `
                    <a class="year-item" href="/cves/${entry.id}">
                        <div>
                            <div class="list-title">${entry.id}</div>
                            <div class="list-subtitle">${entry.timestamp}</div>
                        </div>
                    </a>
                `).join('')}
               </div>`
            : `<div class="empty-state">
                <p>No entries recorded for ${bucket.year}</p>
               </div>`;
        
        yearPanel.innerHTML = `
            <div class="card-header flex justify-between items-center">
                <h3 class="card-title">${bucket.year}</h3>
                <span class="badge badge-dark">${bucket.count}</span>
            </div>
            ${entriesHtml}
        `;
        
        yearGrid.appendChild(yearPanel);
    });
}
